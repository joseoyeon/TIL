# DLL 지연 로드

명시적 로드와 암시적 로드의 혼합 상태이다.

DLL링크 시 암시적 로드처럼 하지만 실제 동작은 명시적 방식으로 작동한다.

이미지가 실행될 때 DLL을 로드하는 것이 아니라 DLL이 내보낸 함수가 최초로 호출될 때 DLL이 매핑된다.

DLL로드가 엄청 많은 경우 프로세스 로딩이 굉장히 느릴 것이다.

DLL 지연 로드를 통해 로드되는 DLL을 분산시킬 수 있으며 똑같은 DLL이라도 실행중에 교체가 가능하다.

예를 들어 프로그램 실행 시 특정 DLL의 버전 검사 후 프로세스 종료없이 새 DLL로 바꿀 수 있다.

암시적 방식으로 하면 DLL이 이미 주소공간으로 매핑되어있어서 교체할 수 없다.

지연 로드 옵션을 걸면 OS에서 프로세스 실행 시 DLL 로딩을 못하게 한다.

이후 .didat라는 지연 로드 섹션을 만들어서 실행 파일 이미지에 끼워넣는다. 이 섹션에는 dll에서 가져와야할 함수에 대한 정보가 담겨있다.

dll이 아직 매핑되지 않았기 때문에 dll이 내보낸 함수를 호출한다면 __delayLoadHelper2라는 래퍼 함수로 대체하여 다음 작업을 수행한다.

__delayLoadHelper2는 지연 로드 섹션을 참고하여 DLL을 LoadLibrary를 통해 로드하고 GetProcAddress로 해당 함수 주소를 얻는다.

이후 획득한 함수의 구조를 고정시켜 __delayLoadHelper2가 아닌 해당 모듈에 대한 호출이 되도록 한다.

해당 교체 과정이 책에 상세하게 있는데 너......무어려워서 나중에 보기로 하였음.