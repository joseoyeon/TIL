# 스텔스 프로세스

API 후킹을 이용하여 다른 프로세스에서 특정 프로세스를 숨기는 기법이다.

프로세스 리스트를 조회하는 모든 프로세스를 후킹해야해서 글로벌 후킹과 자동 후킹 기술이 필요하다.

프로세스 리스트를 조회하는 API들은 내부적으로 ntdll.ZwQuerySystemInformation() API를 호출한다.

해당 API를 후킹하여 특정 프로세스 정보를 지우면 특정 프로세스가 스텔스 프로세스가 된다.

책에서 이번에 할 API후킹은 DLL인젝션을 통해 IAT변조가 아니라 직접 DLL의 코드를 패치하여 후킹한다.

근데 위 함수가 윈8부터 안쓰인다고 한다. 그래서 윈10 내용으로 구글링해서 후킹해야한다.

NtQuerySystemInformation 라는 함수를 쓴다! 이름은 똑같다. 작업관리자도 해당 모듈을 ntdll로부터 로드해서 쓰는것을 확인하였다. 해당 API를 후킹해보자.

_함수 정보 : https://docs.microsoft.com/en-us/windows/desktop/api/winternl/nf-winternl-ntquerysysteminformation_

![image](https://user-images.githubusercontent.com/41255291/51722529-03f53f00-2099-11e9-84e9-72f08a081ef4.png)

책 뒤에 나오는 숏점프 하고 롱점프하는식으로 2단점프하려했으나 실패했다.

책에는 함수 시작이 MOV EDI EDI (8BFF)라는 값을 이용해 7바이트 핫 패치를 한다.

하지만 윈10 64비트에서는 해당 함수가 4C 8B라는 명령어로 시작하는데 이게 무슨 명령어인지 모르겠다.

찾아보니 64비트에서 kernel32.dll 은 sysWow64폴더의 kernel32.dll로 강제 리다이렉트 된다고 한다.

## ---어제 삽질 내역---

1. 윈10 explorer.exe는 64비트 프로그램

이전 책에서 kernel32.dll 의 WriteFile() API를 후킹하는 예제를 사용하기 위해 32비트 dll과 32비트 주입기를 사용해 32비트 프로그램 대상으로 후킹을 진행함.

이번에는 32비트 주입기로 32비트, 64비트 dll을 주입하는데 access_denied뜨면서 안되어 구글링해보니 32비트에서 64비트 프로세스로 dll을 주입시켜서 발생하는 문제라고 함.

그래서 주입기, dll 모두 64비트로 전환하였더니 주입은 성공함.

하지만 후킹이 안된다.

2. 64비트 컴파일시 주소체계가 자동으로 변환된다.(?)

LPVOID 같은거 DWORD가 아닌 QWORD로 바뀐다. QWORD는 따로 typedef 안되어있어서 typedef로 UNSIGNED LONG LONG 선언하여 사용하였음. 이것때문에 후킹이 안된거였다.

메모리 참조하는데 64비트 주소공간에서 32비트가지고 하니까 당연히 고장난거였음.

3. taskmgr는 CreateToolhelp32Snapshot에서 안뜬다.

주입기에서 작업관리자 대상으로 주입을 하려했더니 프로세스 번호 2892가 안보임! 작업관리자에서는 작업관리자 스스로가 보인다.

Process Explorer에서는 Taskmgr이 보임. 원리가 무엇일까..

Taskmgr과 Taskmgr 모두 NtQuerySystemInformation 함수를 Import하고 있는데 이쪽으로 조사를 해봐야 할 것 같다.