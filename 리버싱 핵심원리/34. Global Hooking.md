# Global Hooking

스텔스 프로세스에서 이어지는 내용이다.

DLL을 주입한 프로세스만 특정 프로세스를 탐지하지 못한다.

DLL이 주입되지 않은 프로세스들은 모든 프로세스를 탐지할 것이다.

따라서 실행중인, 앞으로 실행될 프로세스들에게 모두 DLL을 주입시켜야 완벽한 스텔스라고 할 수 있다.

그래서 CreatProcess라는 함수를 후킹할 수 있는데 이 함수는 내부적으로 NtResumeThread라는 API를 호출하는데 해당 API를 후킹해볼것이다.

CrateProcess는 MDSN에서 공식문서로 제공하는 API이지만 NtResumeThread는 Undocument API이다.

따라서 이름같은게 조금씩 바뀔 수 있다.

일단 지금까지 실행 결과는 explorer.exe에 주입후 프로세스 몇개 실행 시 Taskmgr.exe는 DLL주입이 안되었으며 ProcessExplorer.exe는 주입이 되어 DllInjecter.exe가 안보였다.

하지만 후킹이 잘못되었는지 크롬이나 다른 탐색기가 작동을 안한다... 고쳐야한다.

크롬은 인젝션은 되어서 후킹이 일어났으니 무언가 꼬인것으로 예상된다.

32비트라 주입안되는 프로세스도 있을것인데 같이 생각을 해보아야겠음.

Injecton, Ejection 모두 에러가 났었는데 아무것도 안한것같은데 갑자기 해결되었음.

디버깅해보니 DLLMainStartup 함수쪽부터 에러가 나던데 손도 대지 않았던 부분이었다.

일단 주입을 하고 생성되는 하위 프로세스에 대해 자동적으로 DLL 후킹이 일어나긴 한다.

![image](https://user-images.githubusercontent.com/41255291/52280424-33f8e800-299f-11e9-87af-4ba92a4c2dc8.png)

크롬 에러의 경우 위와 같이 Injection은 이루어 졌으나 PID 10360은 Injection이 안되었으며 PID 15208은 Suspended 상태로 상위 Chrome이 ResumeThread를 못해준 것으로 추측된다.