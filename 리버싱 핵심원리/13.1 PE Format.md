# PE File Format

Windows 운영체제에서 사용되는 실행파일의 형식.

기존 UNIX에서 사용되는 COFF를 기반으로 Microsoft에서 만들었다.

## PE File의 종류
- 실행 계열 : EXE, SCR
- 라이브러리 계열 : DLL, OCX, CPL, DRV
- 드라이버 계열 : SYS, VXD
- 오브젝트 파일 계열 : OBJ

실행 계열 빼고 모두 단독으로 실행하기는 어려워 보이지만 간접적으로라도 실행할 수 있어서 실행 파일로 분류된다. OBJ파일은 PE 제작자 측에서는 실행이 불가능하지만 PE포맷으로 간주한다.

하지만 OBJ 파일 자체로는 어떠한 형태로의 실행도 불가능해서 리버싱에서는 관심을 두지 않는다.

## 기본 구조
![image](https://user-images.githubusercontent.com/41255291/50678959-8499c000-1044-11e9-806d-0181b34d0839.png)

기본적으로 DOS header ~ Section header를 PE헤더라 부르며 그 밑의 Section들을 Body라고 부른다.

섹션 헤더에는 각 섹션에 대한 파일/메모리에서의 크기, 위치, 속성 등이 정의되어있다.

섹션 헤더와 각 섹션 끝부분은 NULL로 패딩된 것을 볼 수 있다.

이는 컴퓨터에서 메모리, 네트워크 패킷등의 처리를 효율적으로 하기 위하여 '최소 기본 단위'라는 개념을 사용하는데 PE 파일도 동일한 개념이 적용되어 최소 기본 단위에 미치지 못하는 크기는 NULL로 패딩되어 최소 기본 단위를 맞추게 된다.

위 그림의 주소를 보면 오프셋이 예쁘게 정돈되어있는것을 볼 수 있다.

## VA & RVA

VA(Virtual Address)는 프로세스 '가상'메모리의 '절대'주소를 말하며

RVA(Relative Virtual Address)는 기준 위치(Image Base)에서부터의 상대주소를 말한다.

    VA = RVA + Image Base

PE 헤더의 정보는 RVA 형태로 된 것이 많다. 왜냐하면 DLL등이 PE파일의 가상 메모리에 매핑될 때 이미 다른 파일이 로딩되어 있을 수 있다. 그렇다면 재배치를 통해 위치 즉, 주소가 바뀌게 되는데 이때 주소가 모두 절대주소로 쓰여있다면 정상 액세스가 불가능할 것이다. -> 이 부분 뒤에서 또 다룬다

32비트 OS는 프로세스마다 4GB의 가상메모리가 주어진다. 레지스터가 32비트라서 주소공간을 2^32까지밖에 표현을 못하기 때문에

## PE Header

부터는 내용이 많아서 다음 md파일로 넘김.

이번장은 그냥 이런게 있구나~하고 넘기면 될 것 같다. 다음장부터 헬이다.

## 추가 - 의문점

    PE파일이 메모리에 올라갈때 왜 섹션크기가 달라질까!

- File의 Section 크기가 더 작은 경우

당연(?)하게 NULL 패딩된 부분이 짤릴것이다. 그림보면 .text의 경우 File에서 7800이 NULL padding 포함이고 Memory에서는 NULL padding 제외한 크기이다.

- File의 Section 크기가 더 큰 경우

.data Segment를 define한다고 가정하면 그곳에는 초기화되지 않은 데이터 배열이 포함되어있을 것이다. 데이터 초기화가 안되어서 Raw Size가 0이고 메모리상에서는 초기화가 일어나면서 크기가 늘어난다고 한다. ~~무슨소리지~~

전역변수 같은 것을 사용할 경우 메모리상에서는 bss영역에 할당이 되는데 이 영역이 File상에는 존재하지 않는 Section이라고함. 그래서 이러한 데이터는 File상태에서 크기가 0이다.

출처 : http://www.asmcommunity.net/forums/topic/?id=29605